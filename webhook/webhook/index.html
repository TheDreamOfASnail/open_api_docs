<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://api-docs.convertlab.com/webhook/webhook/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Webhook 使用说明 - Convertlab 文档中心</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../test/css/print.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Convertlab 文档中心</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">OpenAPI V1 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../..">创建集成应用</a>
</li>
                                    
<li >
    <a href="../../api/accesstoken/">获取ACCESS_TOKEN</a>
</li>
                                    
<li >
    <a href="../../api/customer/">客户信息</a>
</li>
                                    
<li >
    <a href="../../api/customerevent/">客户事件</a>
</li>
                                    
<li >
    <a href="../../api/tag/">客户标签</a>
</li>
                                    
<li >
    <a href="../../api/list/">客户群组</a>
</li>
                                    
<li >
    <a href="../../api/deal/">客户交易</a>
</li>
                                    
<li >
    <a href="../../api/third_party_data/">媒体数据</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">前端埋点 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../track/site_collection_guide/">通过网站埋点进行数据采集</a>
</li>
                                    
<li >
    <a href="../../track/dmhubsdk_ios_guide/">通过 iOS SDK 进行数据采集</a>
</li>
                                    
<li >
    <a href="../../track/dmhubsdk_android_guide/">通过 Android SDK 进行数据采集</a>
</li>
                                    
<li >
    <a href="../../track/MiniProgram_SDK_User_Guide/">通过微信小程序 SDK 进行数据采集</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Webhook <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li class="active">
    <a href="./">Webhook 使用说明</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">会员 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../member/">Api接口</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../../track/MiniProgram_SDK_User_Guide/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../../member/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/xsio/open_api_docs/edit/master/docs/webhook/webhook.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#1-webhook">1. Webhook 简介</a></li>
        <li class="main "><a href="#2-webhook">2. 新建 Webhook</a></li>
        <li class="main "><a href="#3-webhook">3. 群发 Webhook消息</a></li>
        <li class="main "><a href="#4-webhook">4. 测试 Webhook</a></li>
        <li class="main "><a href="#5">5. 查看发送结果</a></li>
        <li class="main "><a href="#6-webhook">6. Webhook 鉴权</a></li>
            <li><a href="#61-webhook">6.1 Webhook秘钥</a></li>
            <li><a href="#62">6.2 基本身份认证</a></li>
        <li class="main "><a href="#7-webhook">7. Webhook 触发类型说明</a></li>
            <li><a href="#71">7.1 固定事件触发</a></li>
            <li><a href="#72">7.2 固定事件触发</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="1-webhook">1. Webhook 简介</h2>
<p>DM Hub 平台提供了各种 Open API 供外部系统调用，但在某些情况下，可能需要 DM Hub 在<strong>合适的时刻</strong>能够<strong>主动推送消息</strong>给外部系统，例如在自动流程执行到特定步骤时，能推送消息给客户的各种终端系统。</p>
<p>Webhook 功能就是 DM Hub 提供的消息推送机制，能够给在 DM Hub 平台上注册过的接口推送消息。</p>
<p>比如，如果某个客户活跃度达到了 500 分，达到你公司的“高质量线索”标准，你就可以以“活跃度达到 500 分”为触发条件，使用DM Hub 的 Webhook 功能，自动给你的 CRM 系统发送此通知，将该客户等级上调。</p>
<h2 id="2-webhook">2. 新建 Webhook</h2>
<p>在【设置】-【Webhook】中新建 Webhook，填写相关参数配置后，点击【保存】完成创建。</p>
<p><img alt="left | 0x0" src="../../resources/assets/webhook_guide21.png" /></p>
<p>参数说明：</p>
<ul>
<li>
<p>Web Hook 配置名称：给新建的 Webhook 起一个有意义的名称，该名称会显示在左侧的列表中，方便后续查看和更改。</p>
</li>
<li>
<p>消息接收地址：要接收消息推送的接口地址，必须是合法的完整地址，包含使用的协议（如 http 或 https）。</p>
</li>
<li>
<p>鉴权方式：用于对消息传递的安全性进行保护。</p>
<ul>
<li>秘钥：用于对消息内容进行签名，在接收到消息时进行<a href="#61-webhook">验签</a>，从而保证消息来源以及消息内容没有被篡改过。</li>
<li>Basic Authentication: 发送消息到接收服务器时，会在Http header中加上预先设置好的身份信息，以保证消息接收服务器的安全。</li>
</ul>
</li>
<li>
<p>触发类型</p>
</li>
<li>
<p>非固定事件触发： 可在自动流程中作为一个动作组件，或手动圈选人群推送消息。选择此触发类型，需设置消息类型和消息体。<a href="#71">见7.1非固定事件触发</a></p>
<ul>
<li>
<p>消息类型： 可选择以Json或者文本格式发送消息。如果消息类型为Json，则Http header中的Content-Type为<code>application/json</code>，如果为文本则为<code>text/plain</code></p>
</li>
<li>
<p>消息体：可自定义消息内容，并可选择插入客户的属性。</p>
</li>
<li>
<p>选择会员属性/选择客户属性：从下拉列表中选取一个会员/客户属性，添加到消息体中。</p>
</li>
<li>
<p>属性为空时显示内容：当选择的会员/客户属性不存在，则以此项内容填充到消息体中。</p>
</li>
</ul>
</li>
<li>
<p>固定事件触发：指定触发事件后，发生该事件将自动触发此webhook。目前可选择的事件包括会员等级升级，会员等级降级，系统发放优惠券，领取优惠券和核销优惠券。<a href="#72">见7.2固定事件触发</a></p>
</li>
<li>
<p>是否激活：DM Hub 只会向处于激活状态的 Webhook 推送消息，如果不想接收消息推送，则可以在此关闭推送功能。</p>
</li>
<li>
<p>是否自动重试：如果推送失败，会自动进行重试。自动重试机制：间隔 30 分钟左右进行第 1 次重试，之后每次重试的间隔递增 30 分钟左右，直至推送成功或自动重试次数达到 3 次。</p>
</li>
</ul>
<h2 id="3-webhook">3. 群发 Webhook消息</h2>
<p>Webhook创建完成后，如果该Webhook的触发类型为非固定事件触发，需要进行手动群发。</p>
<p>发送步骤：</p>
<ol>
<li>
<p>在Webhook列表中选择需要群发的Webhook，点击发送消息按钮。  </p>
</li>
<li>
<p>选择群发</p>
</li>
<li>
<p>在发送至群组的下拉列表中选择群组  </p>
</li>
<li>
<p>选择发送时间<br />
如果选择定时发送则系统会在指定的时间开始发送Webhook消息。</p>
</li>
</ol>
<h2 id="4-webhook">4. 测试 Webhook</h2>
<p>在针对群组进行群发Webhook之前，可选择某个用户来发送单条消息以进行测试</p>
<p>测试步骤：</p>
<ol>
<li>
<p>在Webhook列表中选择需要群发的Webhook，点击发送消息按钮。 </p>
</li>
<li>
<p>选择测试发送</p>
</li>
<li>
<p>在请选择客户的输入框中输入客户姓名、微信昵称或者手机号码。</p>
</li>
</ol>
<h2 id="5">5. 查看发送结果</h2>
<p>在webhook列表中可查看webhook发送的结果。</p>
<ol>
<li>
<p>如果是测试消息，可查看到消息发送的详情，包括消息体、消息头以及服务器的响应结果</p>
</li>
<li>
<p>如果是群发的webhook消息，可以在发送列表页上看到该消息的发送状态：发送中、已完成等。</p>
</li>
</ol>
<h2 id="6-webhook">6. Webhook 鉴权</h2>
<h3 id="61-webhook">6.1 Webhook秘钥</h3>
<p>对于设置了秘钥的 Webhook，DM Hub 向消息接收地址发送请求时，会使用秘钥生成消息内容的 hmac sha256 hex 摘要签名，携带在 header 的 <code>X-Clab-Hmac-Signature</code> 中。</p>
<p>在接收消息的代码中，使用相同的秘钥生成接收到的 payload 的 hmac sha256 hex 摘要签名，并与 header 中的签名进行比对，如果两者一致，则验签通过，表明消息来源可靠且消息内容没有被篡改过。</p>
<p>生成 hmac sha256 hex 摘要签名：</p>
<ul>
<li>使用的 jar 包：</li>
</ul>
<pre><code>com.google.code.gson:gson:2.8.1
commons-codec:commons-codec:1.10
</code></pre>

<ul>
<li>生成签名代码示例：</li>
</ul>
<pre><code class="java">import com.google.gson.Gson
import com.google.gson.GsonBuilder
import org.apache.commons.codec.digest.HmacUtils

String sign(Map payload, String secret) {
    Gson gson = new GsonBuilder().create();
    String str = gson.toJson(payload);
    return HmacUtils.hmacSha256Hex(secret, str.replaceAll(&quot;\\s+&quot;, &quot;&quot;));
}
</code></pre>

<h3 id="62">6.2 基本身份认证</h3>
<p>对于设置了基本身份认证的 Webhook， DM Hub想消息地址发送请求时，会在http header中添加Authorization，示例代码如下：</p>
<pre><code class="java">String content = username + &quot;:&quot; + password;
String token = &quot;Basic &quot; + Base64.getEncoder().encodeToString(content(&quot;utf-8&quot;));
httpPost.setHeader(&quot;Authorization&quot;, token);
</code></pre>

<h2 id="7-webhook">7. Webhook 触发类型说明</h2>
<p>Webhook 支持消息类型包括：自动流相关、表单提交相关以及会员相关，具体使用如下所述。</p>
<h3 id="71">7.1 固定事件触发</h3>
<h4 id="711-webhook">7.1.1 使用 Webhook 接收自动流相关消息</h4>
<p>如下图所示，在创建自动流程时，可以添加 Webhook 动作节点，用以将相关的上下文信息通过 Webhook 推送给外部系统。</p>
<p><img alt="left | 0x0" src="../../resources/assets/webhook_guide22.png" /></p>
<p><img alt="left | 0x0" src="../../resources/assets/webhook_guide23.png" /></p>
<h4 id="712-webhook">7.1.2 使用 Webhook 接收表单提交相关消息</h4>
<p>如下图所示，在包含表单的微页面中，可以设置提交表单后触发 Webhook，用以将相关的上下文信息通过 Webhook 推送给外部系统。</p>
<p><img alt="left | 0x0" src="../../resources/assets/webhook_guide24.png" /></p>
<h3 id="72">7.2 固定事件触发</h3>
<p>目前支持以下5种会员相关事件。</p>
<h4 id="721">7.2.1 会员等级升级事件</h4>
<p><code>loyalty/membership_level_up</code></p>
<p>消息内容 payload：</p>
<pre><code class="json">{
    &quot;tenantId&quot;: &lt;tenantId&gt;,
    &quot;event&quot;: &quot;loyalty/membership_level_up&quot;,
    &quot;membershipId&quot;: &quot;&lt;会员 ID&gt;&quot;,
    &quot;date&quot;: &quot;&lt;事件发生的时间&gt;&quot;,
    &quot;oldLevelId&quot;: &lt;原等级 ID&gt;,
    &quot;newLevelId&quot;: &lt;新等级 ID&gt;,
    &quot;oldLevel&quot;: &quot;&lt;原等级名称&gt;&quot;,
    &quot;newLevel&quot;: &quot;&lt;新等级名称&gt;&quot;
}
</code></pre>

<h4 id="722">7.2.2 会员等级降级事件</h4>
<p><code>loyalty/membership_level_down</code></p>
<p>消息内容 payload：</p>
<pre><code class="json">{
    &quot;tenantId&quot;: &lt;tenantId&gt;,
    &quot;event&quot;: &quot;loyalty/membership_level_down&quot;,
    &quot;membershipId&quot;: &quot;&lt;会员 ID&gt;&quot;,
    &quot;date&quot;: &quot;&lt;事件发生的时间&gt;&quot;,
    &quot;oldLevelId&quot;: &lt;原等级 ID&gt;,
    &quot;newLevelId&quot;: &lt;新等级 ID&gt;,
    &quot;oldLevel&quot;: &quot;&lt;原等级名称&gt;&quot;,
    &quot;newLevel&quot;: &quot;&lt;新等级名称&gt;&quot;
}
</code></pre>

<h4 id="723">7.2.3 系统发放优惠券事件</h4>
<p><code>loyalty/loyalty_dispatch_coupon</code></p>
<p>消息内容 payload：</p>
<pre><code class="json">{
    &quot;tenantId&quot;: &lt;tenantId&gt;,
    &quot;event&quot;: &quot;loyalty/loyalty_dispatch_coupon&quot;,
    &quot;membershipId&quot;: &quot;&lt;会员 ID&gt;&quot;,
    &quot;date&quot;: &quot;&lt;事件发生的时间&gt;&quot;,
    &quot;couponId&quot;: &quot;&lt;优惠券 ID&gt;&quot;,
    &quot;couponName&quot;: &quot;&lt;优惠券名称&gt;&quot;,
    &quot;batchId&quot;: &quot;&lt;批次号&gt;&quot;,
    &quot;couponCode&quot;: &quot;&lt;优惠券 code（该客户的唯一 code）&gt;&quot;,
    &quot;startDate&quot;: &quot;&lt;起始有效日期&gt;&quot;,
    &quot;endDate&quot;: &quot;&lt;截止有效日期&gt;&quot;
}
</code></pre>

<h4 id="724">7.2.4 领取优惠券事件</h4>
<p><code>loyalty/membership_draw_coupon</code></p>
<p>消息内容 payload：</p>
<pre><code class="json">{
    &quot;tenantId&quot;: &lt;tenantId&gt;,
    &quot;event&quot;: &quot;loyalty/membership_draw_coupon&quot;,
    &quot;membershipId&quot;: &quot;&lt;会员 ID&gt;&quot;,
    &quot;date&quot;: &quot;&lt;事件发生的时间&gt;&quot;,
    &quot;couponId&quot;: &quot;&lt;优惠券 ID&gt;&quot;,
    &quot;couponName&quot;: &quot;&lt;优惠券名称&gt;&quot;,
    &quot;couponCode&quot;: &quot;&lt;优惠券 code（该客户的唯一 code）&gt;&quot;,
    &quot;startDate&quot;: &quot;&lt;起始有效日期&gt;&quot;,
    &quot;endDate&quot;: &quot;&lt;截止有效日期&gt;&quot;
}
</code></pre>

<h4 id="725">7.2.5 核销优惠券事件</h4>
<p><code>loyalty/membership_redeem_coupon</code></p>
<p>消息内容 payload：</p>
<pre><code class="json">{
    &quot;tenantId&quot;: &lt;tenantId&gt;,
    &quot;event&quot;: &quot;loyalty/membership_redeem_coupon&quot;,
    &quot;membershipId&quot;: &quot;&lt;会员 ID&gt;&quot;,
    &quot;date&quot;: &quot;&lt;事件发生的时间&gt;&quot;,
    &quot;couponId&quot;: &quot;&lt;优惠券 ID&gt;&quot;,
    &quot;couponName&quot;: &quot;&lt;优惠券名称&gt;&quot;,
    &quot;couponCode&quot;: &quot;&lt;优惠券 code（该客户的唯一 code）&gt;&quot;
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2017, Convertlab</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "search": 83, "previous": 80, "next": 78};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../test/swagger-ui.min.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
